<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="main.css" type="text/css" />
<link rel="stylesheet" href="blog.css" type="text/css" />
<link rel="alternate" type="application/rss+xml" title="Subscribe to this page..." href="feed.rss" />
<title>Linux, Software and play</title>
</head><body>
<div id="divbodyholder">
<div class="headerholder"><div class="header">
<div id="title">
<h1 class="nomargin"><a class="ablack" href="https://gador.github.io/index.html">Linux, Software and play</a></h1>
<div id="description">A blog about all kinds of things concerning software and Linux</div>
</div></div></div>
<div id="divbody"><div class="content">
<h3><a class="ablack" href="contact---update17621.html">
Contact - Update
</a></h3>
<!-- bashblog_timestamp: #201809261650.28# -->
<div class="subtitle">September 26, 2018 &mdash; 
Florian Brandes
</div>
<!-- text begin -->

<h4>UPDATE:</h4>

<p>I've updated my PGP setup. I now use an explicit "master key".
The master key resides inside a network isolated VM and is only used
to sign my other keys.</p>

<p>Right now, I use (besides my master key) two keys:</p>

<ol>
<li>The blog signing key</li>
<li>My (personal) Email key</li>
</ol>

<h4>My master key:</h4>

<p><code>
pub   rsa4096 2018-09-25 [C]
      6B5B 746D 864E 8C50 40BA  3DDF 3FC2 A82D EEFD BEC1
uid           [ultimate] Florian Brandes (Master Signing Key)
</code></p>

<h4>My blog signing key:</h4>

<p><code>
pub   rsa4096 2017-07-14 [SC] [expires: 2019-09-26]
      EBE9 6693 4FE9 D027 2253  A747 7350 8CAD 3E13 066C
uid           [ultimate] Florian Brandes (Blog signing key)
sub   rsa4096 2017-07-14 [E] [expires: 2019-09-26]
</code></p>

<h4>My email key:</h4>

<p><code>
pub   rsa4096 2018-09-22 [SC] [expires: 2019-09-26]
      6C7C 130D 706D F5A7 DB8A  C74F 8FD6 7E87 40FE ECA5
uid           [ultimate] Florian Brandes &lt;florian.brandes@posteo.de&gt;
uid           [ultimate] Florian Brandes &lt;florian.brandes@gmx.de&gt;
sub   rsa4096 2018-09-22 [E] [expires: 2019-09-26]
sub   rsa4096 2018-09-22 [S] [expires: 2019-09-26]
</code></p>

<p>I also updated my email. I am moving to @posteo.de (which I consider a better
privacy oriented company). I am still registered at @gmx.de, but will only answer
from the new @posteo.de address.</p>

<p>I will update the keys accordingly on the keyservers and on keybase.io</p>

<p>Tags: <a href='tag_contact.html'>contact</a>, <a href='tag_email.html'>email</a>, <a href='tag_about.html'>about</a>, <a href='tag_gpg.html'>gpg</a></p>
<!-- text end -->
<h3><a class="ablack" href="title-on-this-line.html">
Title on this line
</a></h3>
<!-- bashblog_timestamp: #201809261554.38# -->
<div class="subtitle">September 26, 2018 &mdash; 
Florian Brandes
</div>
<!-- text begin -->

<p>The rest of the text file is a <strong>Markdown</strong> blog post. The process will continue
as soon as you exit your editor.</p>

<p>Tags: <a href='tag_keep-this-tag-format.html'>keep-this-tag-format</a>, <a href='tag_tags-are-optional.html'>tags-are-optional</a>, <a href='tag_beware-with-underscores-in-markdown.html'>beware-with-underscores-in-markdown</a>, <a href='tag_example.html'>example</a></p>
<!-- text end -->
<h3><a class="ablack" href="debugging-pass-tomb-on-qubes-32.html">
Debugging pass-tomb on Qubes 3.2
</a></h3>
<!-- bashblog_timestamp: #201707181246.02# -->
<div class="subtitle">July 18, 2017 &mdash; 
Florian Brandes
</div>
<!-- text begin -->

<h2>The Problem</h2>

<pre><code>pass open
(do some stuff)
pass close
tomb [E] Tomb is busy, cannot umount!
</code></pre>

<h2>The workaround (not a solution)</h2>

<p>Aha. So I wrote <a href="https://gador.github.io/how-to-manage-passwords-with-pass.html">here</a> about pass. Specifically I wrote</p>

<pre><code>"For whatever reason, it throws an error when closing, 
I haven't figured out why, yet, but the tomb closes nevertheless and detaches. 
If you found a way to verbose the output of pass close please let me know and send me an email ;-)"
</code></pre>

<p>So I found a way to verbose my output. It is <em>really</em> simple (duh..):</p>

<pre><code>pass close -v
</code></pre>

<p>That gives me:</p>

<pre><code>tomb  .  Closing tomb [.password] mounted on /home/user/.password-store
tomb  .  Closing tomb bind hook: /rw/home/user/.password-store
umount: /home/user/.password-store: not mounted
tomb [E] Tomb is busy, cannot umount!
</code></pre>

<p>Wait, why is there a tomb bind hook to /rw/home/user ?
Qubes exposes the private read-write partition for each VM to /rw . So far, so good. But then it <strong>binds</strong> /home to /rw/home.</p>

<p>But what does that have to do with the error? 
Looking in the source of pass-tomb you see the opening operation:</p>

<pre><code>_tomb open "$TOMB_FILE" -k "$TOMB_KEY" -g "${PREFIX}/${path}"
</code></pre>

<p>so TOMB<em>_</em>FILE is obvious, the -k option is for the location of the TOMB_KEY. The -g tells tomb to use
GPG instead of a symetric key and the last option is the most interesting. It teels tomb (which tells cryptsetup)
where to mount. Omiting it leads to a mounted tomb filesystem at /media/.password. Umounting with </p>

<pre><code>tomb close
</code></pre>

<p>yields no error! So where is the difference? </p>

<p>Quite easy: Mounting at /home/user/.password-store mounts inside a mount (a bound mount to be exact) which leads to
a double entry in mount:</p>

<pre><code>mount
[...]
/dev/xvdb on /rw type ext4 (rw,relatime,discard,data=ordered)
/dev/xvdb on /home type ext4 (rw,relatime,discard,data=ordered)
/dev/xvdb on /var/spool/cron type ext4 (rw,relatime,discard,data=ordered)
tmpfs on /run/user/1000 type tmpfs (rw,nosuid,nodev,relatime,size=31284k,nr_inodes=39100,mode=700,uid=1000,gid=1000)
/dev/mapper/tomb..password.1500372740.loop10 on /home/user/.password-store type ext4 (rw,nodev,noatime,data=ordered)
/dev/mapper/tomb..password.1500372740.loop10 on /rw/home/user/.password-store type ext4 (rw,nodev,noatime,data=ordered)
</code></pre>

<p>as you can see, /dev/xvdb is mounted three times. This is because two of those are bound directories. Just looking at the 
output of mount (or /proc/mounts) will not help you. --bind is a mount option and is ommited in the final display.. Very helpful..</p>

<p>Looking at the source code of tomb, you'll see:</p>

<pre><code># check if there are binded dirs and close them
    bind_tombs=(`list_tomb_binds $tombname $tombmount`)
    for b in ${bind_tombs}; do
        bind_mapper="${b[(ws:;:)1]}"
        bind_mount="${b[(ws:;:)2]}"
        _message "Closing tomb bind hook: ::1 hook::" $bind_mount
        _sudo umount "`print - ${bind_mount}`" || {
      [...]
    done
    _verbose "Performing umount of ::1 mount point::" $tombmount
    _sudo umount ${tombmount}
    [[ $? = 0 ]] || { _failure "Tomb is busy, cannot umount!" }
</code></pre>

<p>So you see, appreantly tomb thinks that we bound our tomb to another directory and tries to umount it. Unfortunatly, this directory
is not a bound directory but appears twice because it is mounted within a bound directory (and therefore can be accessed via /home/user/.password-store
and /rw/home/user/.password-store). </p>

<p>Sadly, the detection of bound directories in Linux is a <strong>pain</strong>. Tomb iterates through the list generated by mount and looks for 
/dev/mapper/tomb* mounted more than once. This works (normally), but not when it actually isn't a bound directory, but is mounted
<strong>within</strong> one. </p>

<p>So the solution would be a more sophisticated method to determine, whether we bound our password tomb. </p>

<p>One would have to implement this check into tomb instead of a readline of mount output to determine a bound directory.</p>

<p>This is easier than it sounds. You could try:</p>

<pre><code>findmnt --list -o TARGET,SOURCE| grep "\[/"
</code></pre>

<p>But this will only show bound directories, when they bind to a subdirectory of a mounted volume. It won't catch
a bound directory to /home/user/.password-store.</p>

<p>Other options are basically not available or not reliable (see <a href="https://unix.stackexchange.com/questions/18048/list-only-bind-mounts">here</a> for
a discussion on stackexchange.)</p>

<p>So, what to do?</p>

<p>Well I opted for a simple solution. I just commented out the section about the umounting of bound directories in tomb:</p>

<pre><code>    # check if there are binded dirs and close them
    ################################################
    #Commented that in QUbes 3.2 to avoid umounting the
    #correct directory with this umount of the binded directory

#        bind_tombs=(`list_tomb_binds $tombname $tombmount`)
#        for b in ${bind_tombs}; do
#            bind_mapper="${b[(ws:;:)1]}"
#            bind_mount="${b[(ws:;:)2]}"
#            _message "Closing tomb bind hook: ::1 hook::" $bind_mount
#            _sudo umount "`print - ${bind_mount}`" || {
#                [[ -n $SLAM ]] &amp;&amp; {
#                    _success "Slamming tomb: killing all processes using this hook."
#                    slam_tomb "`print - ${bind_mount}`" || _failure "Cannot slam the bind hook ::1 hook::" $bind_mount
#                    umount "`print - ${bind_mount}`" || _failure "Cannot slam the bind hook ::1 hook::" $bind_mount
#                } || {
#                    _failure "Tomb bind hook ::1 hook:: is busy, cannot close tomb." $bind_mount
#                }
#            }
#        done
</code></pre>

<p>This way, tomb will only umount the original mount and the error disapered. </p>

<p>But what, if you <em>actually</em> --bind mounted a password store?</p>

<p>Well this happens:</p>

<pre><code>sudo mount --bind /home/user/.password-store/ /mnt/test/
pass close -v
 .  pass Closing the password tomb /home/user/.password.tomb
  .  tomb  .  Closing tomb [.password] mounted on /home/user/.password-store
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  device-mapper: remove ioctl on tomb..password.1500372740.loop10 failed: Device or resource busy
  .  Device tomb..password.1500372740.loop10 is still in use.
  .  tomb [E] Error occurred in cryptsetup luksClose tomb..password.1500372740.loop10
 [x] Error : Unable to close the password tomb.
</code></pre>

<p>Ok, tomb can't close, because something is still mounted at /dev/mapper/tomb...
Let's just try again:</p>

<pre><code>.  pass Closing the password tomb /home/user/.password.tomb
  .  tomb  .  Closing tomb [.password] mounted on /mnt/test
  .  tomb (*) Tomb [.password] closed: your bones will rest in peace.
 (*) Your password tomb has been closed.
  .  Your passwords remain present in /home/user/.password.tomb.
</code></pre>

<p>Ah, so now the remaining mount was umounted and everything works fine.</p>

<h2>Conclusion</h2>

<p>There doesn't seem to be a clear solution in detecting bound mounts in Linux, currently. So to have pass work correctly in my 
vault-VM (and close the /dev/mapper which holds my password-tree) I did a hack to the tomb script to not check for bound directories.</p>

<p>This is far from ideal, but the only workaround I came up with today.</p>

<p>If you have a better idea, please let me know (or even better, submit a patch to tomb).</p>

<p>Regards,</p>

<p>Florian</p>

<p>Tags: <a href='tag_howto.html'>howto</a>, <a href='tag_linux.html'>linux</a>, <a href='tag_pass.html'>pass</a>, <a href='tag_security.html'>security</a>, <a href='tag_tomb.html'>tomb</a>, <a href='tag_qubes.html'>qubes</a></p>
<!-- text end -->
<h3><a class="ablack" href="how-to-manage-passwords-with-pass.html">
How to manage passwords with pass
</a></h3>
<!-- bashblog_timestamp: #201707171127.11# -->
<div class="subtitle">July 17, 2017 &mdash; 
Florian Brandes
</div>
<!-- text begin -->

<h1>Background</h1>

<h3>Why a password manager?</h3>

<p>Well, if you found this page and are interessted in pass, you must already have your reasons
to look into password managers. For me, it's a basic concept: Use password only once. Don't (<strong>ever</strong>)
reuse passwords or passphrases for other services. If one service gets compromised, you won't
automatically have to worry about your other services. This makes remebering passwords a bitch,
especially if you don't iterate through numbers of your favorite, easy-to-guess, passwords.
Speaking of which, yes, there are tools out there, that can generate very good dictonaries based
on a bit of social engenieering. So you really should use generated passwords. </p>

<h3>Why pass?</h3>

<p>Well, there is a ton of really good password-managers out there. I mean <strong>a lot</strong>. I used 
<a href="https://github.com/zdia/gorilla/wiki">gorilla</a> a long time, but at some point, I wanted to 
sync my passwords with my home computer, my laptop and my work computer. (Yes, arguably, keeping
your password safe sync'd to your work computer bears its risks, but it all comes down to whether
you trust your employer to not backdoor your work computer. I use FDE (full-disk-encryption) and 
my password safe is password protected and encrypted, too, but that won't save you, if your 
employer is determined to eavsdrop on you.)</p>

<p>Anyway, if I change a password on one system and maybe add another on my second system, I will run
into problems using gorilla (gorilla uses a single, encrypted file).</p>

<p>So something new was needed.</p>

<p>First, I looked into online, cloud serving password managers. I ran across <a href="https://www.lastpass.com">lastpass</a>, 
which worked really well with all my systems. Unfortunatly, I was left in the lurch, because I 
didn't want to use the browser plugin for firefox, but rather a standalone app. Lastpass provides such
a solution, even for Linux, but it has two drawbacks:</p>

<ol>
<li><p>It doesn't work on a reasonably new Ubuntu Linux (see below for my ticket to lastpass)</p>

<p>"I am using Ubuntu 17.04 and pocket_x86 does not start, since it complains about the version ob libpng. libpng was updated to v1-6 but your application needs v1-2.</p>

<p>The same problem also applies to the oder version of ubuntu, since it also uses the newer version of libpng. The problem was also reported on your forum (see here: https://forums.lastpass.com/viewtopic.php?f=14&amp;t=232835&amp;p=780625&amp;hilit=pocket_x64#p780625) where the exact same problem was described more than half a year ago!</p>

<p>Could you please update the dynamically linked application to also allow the new version of libpng? (or give me the source code and I'll update your application..)
I do not use FIrefox (or Chrome or any other supported browser) and I do not use windows, so right now I'm stranded and can only use your online website to access my passwords."</p></li>
<li><p>It is closed source. </p></li>
</ol>

<p>They replied that they forwarded it to the development branch, but I never heard back and they closed the ticket. 
I didn't try it since then.</p>

<p>You need to trust lastpass. I do have trust issues, but I was willing to give it a try. I stoped using lastpass
since then, because I couldn't even debug the code myself.</p>

<p>So I decided I needed something else. Since I love my Terminal I got intrigued by the idea of <a href="https://www.passwordstore.org">pass</a>.
It has a built-in git support, which works really well and combined with <a href="https://github.com/roddhjav/pass-tomb#readme">pass-tomb</a>
provides a reasonably secure password store. </p>

<h3>What makes pass different?</h3>

<p>Well, pass uses GPG to encrypt/decrypt your passwords. It saves all your passwords in a directory tree. Each directory
works like a folder in your previous password manager. The directory is stored at ~/.password-store .
You can just enter </p>

<pre><code>pass
</code></pre>

<p>to get an overview or, for example:</p>

<pre><code>pass Email/yahoo
</code></pre>

<p>to get your email password for yahoo. To get a nice overview see <a href="https://www.passwordstore.org">here</a>.</p>

<p>I didn't like that everyone with access to my (decrypted) HDD can see, where I signed up, so I use the pass-tomb extension, as well.
It encrypts your whole .password-store folder into a tomb file with your GPG key.</p>

<h3>How to set pass up</h3>

<p>First I installed pass. It can be found in most package systems of mondern ditros, but I found it won't work
(out of the box) with pass-tomb. So I opted to download it manually and install it manually:</p>

<p><em>You will need git and gpg for this to work</em></p>

<p>First, lets import the public signing key</p>

<pre><code>    gpg --fetch-keys http://www.zx2c4.com/keys/AB9942E6D4A4CFC3412620A749FC7012A5DE03AE.asc
</code></pre>

<p>Now lets download pass in a temporary directory (or wherever you like):</p>

<pre><code>    mkdir tmp
    cd tmp
git clone https://git.zx2c4.com/password-store
    cd password-store
</code></pre>

<p>To verify the integraty of the git branch, run the following command:</p>

<pre><code>    git tag -v 1.7.1
</code></pre>

<p>If version 1.7.1 isn't the curent one, run git tag to get an overview of all the tags.</p>

<p>It shoud read somewhere:</p>

<pre><code>    gpg: Good signature from "Jason A. Donenfeld &lt;Jason@zx2c4.com&gt;"
</code></pre>

<p>Now, you are ready to set up pass. Just run:</p>

<pre><code>    sudo make install
</code></pre>

<p>Thats it. Now you could already start using it. I opted to install the pass extension
for tomb. Acording to the pass-tomb website:</p>

<pre><code>    A pass extension that helps to keep the whole tree of password encrypted inside a tomb.
</code></pre>

<p>So, first intsall the dependencies:</p>

<pre><code>sudo yum install zsh sudo cryptsetup pinentry-curses
</code></pre>

<p>or</p>

<pre><code>sudo apt-get install zsh sudo cryptsetup pinentry-curses
</code></pre>

<p>Next, install tomb:</p>

<pre><code>wget https://files.dyne.org/tomb/Tomb-2.4.tar.gz
wget https://files.dyne.org/tomb/Tomb-2.4.tar.gz.asc
gpg --keyserver pool.sks-keyservers.net --recv 4ACB7D10
gpg --verify Tomb-2.4.tar.gz.asc Tomb-2.4.tar.gz
</code></pre>

<p>It shoud read somewhere:</p>

<pre><code>gpg: Good signature from "Denis Roio (Jaromil) &lt;jaromil@dyne.org&gt;"
</code></pre>

<p>Next, untar, cd into the directory and install</p>

<pre><code>tar xvfz Tomb-2.4.tar.gz
cd Tomb-2.4
sudo make install
</code></pre>

<p>So, to add it to tomb, do the following (in your tmp directory):</p>

<pre><code>    git clone https://github.com/roddhjav/pass-tomb/
    cd pass-tomb
    sudo make install
</code></pre>

<p>Thats it.</p>

<h3>How does it work?</h3>

<p>Pass, by itself, uses GPG to encrypt your password. That automatically means, you will need gpg. I assume, you already have
gpg installed. If you haven't got a gpg private key, or want to create a seperate one, just for your passwords (what I did)
you will need to generate one:</p>

<pre><code>$ gpg --gen-key
gpg (GnuPG) 1.4.21; Copyright (C) 2015 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Please select what kind of key you want:
   (1) RSA and RSA (default)
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
Your selection? 1
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 4096
Requested keysize is 4096 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 0
Key does not expire at all
Is this correct? (y/N) y

You need a user ID to identify your key; the software constructs the user ID
from the Real Name, Comment and Email Address in this form:
    "Heinrich Heine (Der Dichter) &lt;heinrichh@duesseldorf.de&gt;"

Real name: Your name
Email address: email@provider.com
Comment: Password key
You selected this USER-ID:
    "Your name (Password key) &lt;email@provider.com&gt;"

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O
You need a Passphrase to protect your secret key.

We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.

gpg: key ABCD1234 marked as ultimately trusted
public and secret key created and signed.

gpg: checking the trustdb
gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
pub   4096R/ABCD1234 2017-07-17
      Key fingerprint = ABCD EFGH 1234 5678 3C7D  8558 0B49 5647 CD6F 83A4
uid                  Your name (Password key) &lt;email@provider.com&gt;
sub   4096R/EFGH6789 2017-07-17
</code></pre>

<p>With that out of the way, you can initialize the password store. I do recommend using pass-tomb
extension. So with pass-tomb, you first need to create a tomb:</p>

<pre><code>pass tomb &lt;gpg-id&gt;
</code></pre>

<p>where gpg id is the ke id of your GPG key you generated earlier.</p>

<p>If you run into an error like this:</p>

<pre><code>[x] Error : Unable to forge the password tomb.
</code></pre>

<p>you will need more information. Do the following:</p>

<pre><code>rm .password.tomb
pass tomb -v &lt;gpg-id&gt;
</code></pre>

<p>Unfortunatly on my system, tomb detects a swap partion (inside an LVM voulme group which is encrypted)
but won't continue, since in would pose a security risk, if the swap would be unencrypted. Tomb
cannot distingues between that, so it complains:</p>

<pre><code>  .  tomb  .  tomb lock /home/user/.password.tomb -k /home/user/.password.tomb.key
  .  tomb  .  An active swap partition is detected...
  .  tomb [W] This poses a security risk.
  .  tomb [W] You can deactivate all swap partitions using the command:
  .  tomb [W]  swapoff -a
  .  tomb [W] [#163] I may not detect plain swaps on an encrypted volume.
  .  tomb [W] But if you want to proceed like this, use the -f (force) flag.
  .  tomb [E] Operation aborted.
 [x] Error : Unable to forge the password tomb.
</code></pre>

<p>so, I turned off my swap partion for a lack of a better option (you can't pass 
the -f flag to tomb using pass-tomb extension and I was too lazy to hack pass-tomb..)</p>

<pre><code>sudo swapoff -a
</code></pre>

<p>now, it should work.</p>

<p>You will need to enter your passphrase from your GPG key. Tomb initializes and is ready to work.</p>

<p>From now on, you will need to enter </p>

<pre><code>pass open
</code></pre>

<p>before accessing your passwords. When open, you can work with it like described above. When you're done
just enter</p>

<pre><code>pass close
</code></pre>

<p>For whatever reason, it throws an error when closing, I haven't figured out why, yet, but the tomb
closes nevertheless and detaches. If you found a way to verbose the output of <em>pass close</em> please let
me know and send me an email ;-)</p>

<h3>Syncing</h3>

<p>So, to setup a git repository, I used my raspberry pi at home. I started a blank repository</p>

<pre><code>git init --bare ~/.password.git
</code></pre>

<p>Next, on your work PC init a git repository:</p>

<pre><code>pass open
pass git init
pass git remote add origin ssh://username@raspberry_ip/absolute/path/to/.password.git/
pass git push origin master
</code></pre>

<p>(Yes I use ssh to connect to my pi. You will therefore need to set it up. I assume you know how to do that.
I reccommend adding your ssh pulic key to the authorized_keys file of your raspberry to avoid needing
to enter the password everytime you snyc).</p>

<p>From your second PC, you just need to do the same, but replace the last line with:</p>

<pre><code>pass git pull
</code></pre>

<p>Remember to first open your pass tomb, otherwise you will sync the wrong directory!</p>

<p>(pass tomb mounts the tomb over your ~/.password-store directory. So when you forget to open 
your tomb before, it will complain about not initilizing the git repository first and obviously
there won't be any passwords, because pass uses the empty not-mounted ~/.password-store directory)</p>

<p>You can further automate the procedure with a git hook to automatically pull when opened and push when you 
change something. But, again, I was lazy and just do <em>pass git pull</em> and <em>pass git push</em> by hand.</p>

<p>Hope that helped,</p>

<p>Florian</p>

<p>Tags: <a href='tag_linux.html'>linux</a>, <a href='tag_pass.html'>pass</a>, <a href='tag_security.html'>security</a>, <a href='tag_tomb.html'>tomb</a>, <a href='tag_sync.html'>sync</a>, <a href='tag_howto.html'>howto</a></p>
<!-- text end -->
<h3><a class="ablack" href="how-i-backup-in-qubes-32-.html">
How I backup in Qubes 3.2 
</a></h3>
<!-- bashblog_timestamp: #201707161354.37# -->
<div class="subtitle">July 16, 2017 &mdash; 
Florian Brandes
</div>
<!-- text begin -->

<h2>The scenario</h2>

<p>So I want to backup my AppVms in Qubes. Obviously it makes sense, to encrypt the resulting
backup file. Not just so a third party will hae problems decoding my private digital life
but also to ensure integraty. See also <a href="https://www.qubes-os.org/doc/backup-restore/">here</a></p>

<p>The catch: You should use a high entropy passphrase. But entering that on a regular basis 
didn't seem like it would work for me.</p>

<h2>The setup</h2>

<p>I use an external 1 TB HDD attached via usb. The HDD is attached as a block device to a special
<em>"backup"</em> AppVM. <em>backup</em> is obviously not connected to a NetVM and there is nothing special 
in it. </p>

<h2>How I use the backup Manager</h2>

<p>First, I use the Qubes VM Manager to attach the external HDD as a block device to the <em>backup</em> VM. </p>

<p>In it I run:</p>

<pre><code>sudo mount /dev/xvdi1 backup/
</code></pre>

<p>to mount the HDD in the <em>backup</em> folder (which obviously must be created first).</p>

<p>Then, from a dom0 console, I run </p>

<pre><code>qvm-run --pass-io vault-nw 'cat /home/user/.backup_key'
</code></pre>

<p>So, wait, what? </p>

<pre><code>qvm-run --pass-io
</code></pre>

<p>is used to copy file(content) between VMs. It can also be used to copy to dom0. </p>

<pre><code>vault-nw
</code></pre>

<p>is the source VM. In this case, it is my password manager VM.</p>

<pre><code>'cat /home/user/.backup_key'
</code></pre>

<p>This command is executed in the source VM (so in this example <em>vault-nw</em>). And the output
is displayed in the dom0 Terminal. Within the vault-nw I exported my laptop backup key to a plain
text file, called <em>.backup_key</em>. </p>

<p>The content is displayed in dom0 Terminal (which is considered ultimatly trusted) and can be copied through
a simple right click.</p>

<p>In the Qubes VM Manager I shutdown every VM that I want to save, then go to System->Backup VMs.
From there I choose all the VMs to backup. Clicking on Next will show the Dialog, where Qubes
wants to know, where to backup to. Here comes the backup VM handy. Here I choose the <em>backup</em> VM 
as a target and</p>

<pre><code>/home/user/backup/
</code></pre>

<p>as the backup folder. (You remember? The external HDD was mounted here within the <em>backup</em> VM)</p>

<p>Next, I copy/paste the backup key to the dialog and click next. The backup starts.</p>

<h2>Pitfalls</h2>

<p>So, the worst case happend and you need to restore your backup. But wait, what was that horrible
long, high entropy passphrase again? Yeah, right, it is in my password-vault VM. But where is that?
In my backup....</p>

<p>So you see, that sucks.</p>

<p>You should therefore have your passphrase somewhere seperate than <em>within</em> your backup.</p>

<p>I personally use <a href="https://www.passwordstore.org">pass</a> and setup a git repository on my homeserver to sync
to. But that is a story for another blog.</p>

<p>If you have questions or remarks, just drop me an email. </p>

<p>Regards,</p>

<p>Florian</p>

<p>Tags: <a href='tag_qubes.html'>qubes</a>, <a href='tag_backup.html'>backup</a>, <a href='tag_howto.html'>howto</a></p>
<!-- text end -->
<h3><a class="ablack" href="contact---how-to-contact-me.html">
Contact - How to contact me
</a></h3>
<!-- bashblog_timestamp: #201707161308.00# -->
<div class="subtitle">July 16, 2017 &mdash; 
Florian Brandes
</div>
<!-- text begin -->

<p>If you want to contact me, please send an email to: <a href="mailto:florian.brandes@gmx.de">florian.brandes@gmx.de</a>.</p>

<p>My GPG key can be found on the current keyservers. </p>

<p>The key ID currently in use is: 7A04C449</p>

<p>My fingerprint is: F6DE 62EB D6BB 31E0 1803  95B8 A7F7 307B 7A04 C449</p>

<p>Attached is my public key for copy and pasting:</p>

<pre><code>-----BEGIN PGP PUBLIC KEY BLOCK-----

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
33UUCJ6pDCHjWo3Fj5Uqp3nu0g==
=f3TZ
-----END PGP PUBLIC KEY BLOCK-----
</code></pre>

<p>Regards,</p>

<p>Florian</p>

<p>Tags: <a href='tag_contact.html'>contact</a>, <a href='tag_email.html'>email</a>, <a href='tag_about.html'>about</a></p>




<!-- text end -->
<div id="all_posts"><a href="all_posts.html">View more posts</a> &mdash; <a href="all_tags.html">All tags</a> &mdash; <a href="feed.rss">Subscribe</a></div>
</div>
<div id="footer">CC by-nc-nd <a href="">Florian Brandes</a> &mdash; <a href="mailto:florian&#46;brandes&#64;gmx&#46;de">florian&#46;brandes&#64;gmx&#46;de</a><br/>
Generated with <a href="https://github.com/cfenollosa/bashblog">bashblog</a>, a single bash script to easily create blogs like this one</div>
</div></div>
</body></html>
